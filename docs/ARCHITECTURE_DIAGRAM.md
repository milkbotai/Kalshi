# Milkbot Architecture Diagram

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 INTERNET                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              CLOUDFLARE                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ DNS Proxy   │  │ SSL/TLS     │  │ DDoS        │  │ WAF         │            │
│  │ milkbot.ai  │  │ Termination │  │ Protection  │  │ Rules       │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ HTTPS (Cloudflare Origin Cert)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                VPS (Ubuntu)                                       │
│                                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                              NGINX                                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │ Rate Limit  │  │ WebSocket   │  │ Static      │                        │  │
│  │  │ 10 req/sec  │  │ Upgrade     │  │ Caching     │                        │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                        │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│            │                    │                                                │
│            │ :8501              │ :8000                                         │
│            ▼                    ▼                                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │   DASHBOARD     │  │   ANALYTICS     │  │    TRADER       │                 │
│  │   (Streamlit)   │  │   (FastAPI)     │  │   (Python)      │                 │
│  │                 │  │                 │  │                 │                 │
│  │ • 10-city grid  │  │ • /v1/health    │  │ • Trading loop  │                 │
│  │ • Equity chart  │  │ • /v1/metrics   │  │ • Signal gen    │                 │
│  │ • Trade feed    │  │ • /v1/trades    │  │ • Risk mgmt     │                 │
│  │ • Health status │  │ • 60-min delay  │  │ • OMS           │                 │
│  │                 │  │                 │  │                 │                 │
│  │ PUBLIC FACING   │  │ LOCALHOST ONLY  │  │ LOCALHOST ONLY  │                 │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘                 │
│           │                    │                    │                          │
│           │                    │                    │                          │
│           └────────────────────┼────────────────────┘                          │
│                                │                                                │
│                                ▼                                                │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                          POSTGRESQL                                        │  │
│  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐        │  │
│  │  │        ops schema           │  │      analytics schema        │        │  │
│  │  │                             │  │                               │        │  │
│  │  │ • weather_snapshots         │  │ • city_metrics                │        │  │
│  │  │ • market_snapshots          │  │ • strategy_metrics            │        │  │
│  │  │ • signals                   │  │ • equity_curve                │        │  │
│  │  │ • orders                    │  │ • v_public_trades (60m delay) │        │  │
│  │  │ • fills                     │  │ • v_current_health            │        │  │
│  │  │ • positions                 │  │                               │        │  │
│  │  │ • risk_events               │  │                               │        │  │
│  │  │ • health_status             │  │                               │        │  │
│  │  └─────────────────────────────┘  └─────────────────────────────┘        │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                    │                                    │
                    │                                    │
                    ▼                                    ▼
    ┌───────────────────────────┐        ┌───────────────────────────┐
    │        KALSHI API         │        │         NWS API           │
    │                           │        │                           │
    │ • Market discovery        │        │ • Forecasts               │
    │ • Orderbook data          │        │ • Observations            │
    │ • Order placement         │        │ • Grid points             │
    │ • Position tracking       │        │                           │
    │                           │        │                           │
    │ Demo: demo-api.kalshi.co  │        │ api.weather.gov           │
    │ Live: api.kalshi.com      │        │                           │
    └───────────────────────────┘        └───────────────────────────┘
```

## Data Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                            TRADING CYCLE (Every 5 min)                        │
└──────────────────────────────────────────────────────────────────────────────┘

    ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
    │  NWS    │     │ Weather │     │ Signal  │     │  Risk   │     │  OMS    │
    │  API    │────▶│  Cache  │────▶│  Gen    │────▶│  Check  │────▶│         │
    └─────────┘     └─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                                          │
    ┌─────────┐     ┌─────────┐                                          │
    │ Kalshi  │     │ Market  │                                          │
    │  API    │────▶│  Data   │──────────────────────────────────────────┘
    └─────────┘     └─────────┘                                          │
                                                                          │
                                                                          ▼
    ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
    │ Order   │     │ Fill    │     │Position │     │Analytics│     │Dashboard│
    │ Submit  │────▶│ Track   │────▶│ Update  │────▶│ Rollup  │────▶│ Display │
    └─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
```

## Service Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              SERVICE LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         TRADER SERVICE                               │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │ TradingLoop  │  │  Strategies  │  │    Gates     │              │   │
│  │  │              │  │              │  │              │              │   │
│  │  │ • Orchestrate│  │ • DailyHigh  │  │ • Spread     │              │   │
│  │  │ • Multi-city │  │ • DailyLow   │  │ • Liquidity  │              │   │
│  │  │ • Scheduling │  │ • Monthly    │  │ • Edge       │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │     OMS      │  │    Risk      │  │   Kalshi    │              │   │
│  │  │              │  │  Calculator  │  │   Client    │              │   │
│  │  │ • Idempotent │  │              │  │              │              │   │
│  │  │ • Intent key │  │ • Position   │  │ • Auth      │              │   │
│  │  │ • State mgmt │  │ • Circuit    │  │ • Orders    │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       ANALYTICS SERVICE                              │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │   Rollups    │  │    Health    │  │  Analytics  │              │   │
│  │  │              │  │   Monitor    │  │     API     │              │   │
│  │  │ • City       │  │              │  │              │              │   │
│  │  │ • Strategy   │  │ • Component  │  │ • FastAPI   │              │   │
│  │  │ • Equity     │  │ • Aggregate  │  │ • localhost │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       DASHBOARD SERVICE                              │   │
│  │                                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  Streamlit   │  │  Components  │  │    Data     │              │   │
│  │  │     App      │  │              │  │   Provider  │              │   │
│  │  │              │  │ • CityGrid   │  │              │              │   │
│  │  │ • Tabs       │  │ • EquityChart│  │ • Caching   │              │   │
│  │  │ • Auto-refresh│ │ • TradeFeed │  │ • API calls │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Network Topology

```
                        ┌─────────────────┐
                        │    Internet     │
                        └────────┬────────┘
                                 │
                        ┌────────▼────────┐
                        │   Cloudflare    │
                        │   (CDN/WAF)     │
                        └────────┬────────┘
                                 │
                        ┌────────▼────────┐
                        │   Firewall      │
                        │ (80, 443 only)  │
                        └────────┬────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        │               VPS (10.0.0.1)                    │
        │                        │                        │
        │    ┌───────────────────┼───────────────────┐   │
        │    │                   │                   │   │
        │    ▼                   ▼                   ▼   │
        │ ┌──────┐          ┌──────┐          ┌──────┐  │
        │ │NGINX │          │ API  │          │Trader│  │
        │ │:80   │◀────────▶│:8000 │          │      │  │
        │ │:443  │          │      │          │      │  │
        │ └──┬───┘          └──┬───┘          └──┬───┘  │
        │    │                 │                 │      │
        │    │                 │                 │      │
        │    ▼                 ▼                 ▼      │
        │ ┌──────┐          ┌─────────────────────┐    │
        │ │Dash  │          │     PostgreSQL      │    │
        │ │:8501 │◀────────▶│       :5432         │    │
        │ └──────┘          │   (localhost only)  │    │
        │                   └─────────────────────┘    │
        │                                              │
        └──────────────────────────────────────────────┘
                                 │
        ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┼ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─
                                 │
                    External API Connections
                                 │
                ┌────────────────┼────────────────┐
                │                │                │
                ▼                ▼                ▼
        ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
        │  Kalshi     │  │    NWS      │  │ OpenRouter  │
        │  API        │  │    API      │  │    API      │
        │             │  │             │  │  (Optional) │
        └─────────────┘  └─────────────┘  └─────────────┘
```

## Security Boundaries

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PUBLIC ZONE                                     │
│                                                                              │
│   Users ──▶ Cloudflare ──▶ NGINX ──▶ Dashboard (read-only views)           │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                              DMZ (localhost)                                 │
│                                                                              │
│   Dashboard ──▶ Analytics API (metrics, delayed trades)                     │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                              PRIVATE ZONE                                    │
│                                                                              │
│   Trader ──▶ OMS ──▶ Kalshi API (orders, positions)                        │
│   Trader ──▶ PostgreSQL (ops schema - full access)                         │
│                                                                              │
│   ⚠️  NO PUBLIC ACCESS TO:                                                  │
│   • Trading service                                                          │
│   • Database                                                                 │
│   • API keys/secrets                                                         │
│   • Real-time trade data (before 60-min delay)                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 10-City Coverage Map

```
                    ┌─────────────────────────────────────────┐
                    │              UNITED STATES              │
                    │                                          │
                    │     SEA ●                    ● BOS       │
                    │                                          │
                    │                      ● CHI    ● NYC      │
                    │     SFO ●                                │
                    │                              ● PHL       │
                    │            ● DEN                         │
                    │     LAX ●                                │
                    │                                          │
                    │                  ● AUS        ● MIA      │
                    │                                          │
                    └─────────────────────────────────────────┘

    City Clusters:
    ┌────────────────┬────────────────┬────────────────┬────────────────┐
    │   NORTHEAST    │    MIDWEST     │     WEST       │    SOUTH       │
    ├────────────────┼────────────────┼────────────────┼────────────────┤
    │ NYC - New York │ CHI - Chicago  │ LAX - Los Ang. │ MIA - Miami    │
    │ BOS - Boston   │ DEN - Denver   │ SFO - San Fran │ AUS - Austin   │
    │ PHL - Phila.   │                │ SEA - Seattle  │                │
    └────────────────┴────────────────┴────────────────┴────────────────┘
```
